#!/bin/bash
#
# Greengrass Lite Image-Provided Component Deployment Script
# This script deploys components individually using multiple deployments
# Runs after fleet provisioning to ensure the device is fully configured before component deployment
#

set -e

# Configuration
PACKAGES_DIR="/var/lib/greengrass/packages"
IMAGE_COMPONENTS_ROOT="/usr/share/greengrass-image-components"
SERVICE_NAME="ggl.local-deployment.service"

# Detect deployment mode based on directory structure
if [ -d "${PACKAGES_DIR}/recipes" ] && [ "$(ls -A "${PACKAGES_DIR}/recipes" 2>/dev/null)" ]; then
    DEPLOYMENT_MODE="zero-copy"
    RECIPES_DIR="${PACKAGES_DIR}/recipes"
    ARTIFACTS_DIR="${PACKAGES_DIR}/artifacts"
elif [ -d "${IMAGE_COMPONENTS_ROOT}/recipes" ] && [ "$(ls -A "${IMAGE_COMPONENTS_ROOT}/recipes" 2>/dev/null)" ]; then
    DEPLOYMENT_MODE="traditional"
    RECIPES_DIR="${IMAGE_COMPONENTS_ROOT}/recipes"
    ARTIFACTS_DIR="${IMAGE_COMPONENTS_ROOT}/artifacts"
else
    DEPLOYMENT_MODE="none"
    RECIPES_DIR=""
    ARTIFACTS_DIR=""
fi

# Logging functions
log_info() {
    echo "INFO: $1"
}

log_warn() {
    echo "WARN: $1"
}

log_error() {
    echo "ERROR: $1" >&2
}

# Parse component name and version from recipe filename
parse_component_info() {
    local recipe_file="$1"
    local component_file=$(basename "$recipe_file" .yaml)
    
    local component_name=$(echo "$component_file" | sed 's/-[^-]*$//')
    local component_version=$(echo "$component_file" | sed 's/.*-//')
    
    echo "${component_name}:${component_version}"
}

# Verify that a component actually exists (has both recipe and artifacts)
verify_component_exists() {
    local component_name="$1"
    local component_version="$2"
    local recipe_file="$3"
    
    if [ ! -f "$recipe_file" ] || [ ! -r "$recipe_file" ]; then
        log_warn "Recipe file $recipe_file does not exist or is not readable"
        return 1
    fi
    
    if [ "$DEPLOYMENT_MODE" = "zero-copy" ]; then
        local artifacts_path="${ARTIFACTS_DIR}/${component_name}/${component_version}"
        if [ ! -d "$artifacts_path" ]; then
            log_warn "Artifacts directory $artifacts_path does not exist for component ${component_name}"
            return 1
        fi
    fi
    
    if ! grep -q "^RecipeFormatVersion:" "$recipe_file" 2>/dev/null; then
        log_warn "Recipe file $recipe_file does not appear to be a valid Greengrass recipe"
        return 1
    fi
    
    return 0
}

# Deploy a single component
deploy_single_component() {
    local component_name="$1"
    local component_version="$2"
    
    local -a deploy_cmd_args=()
    deploy_cmd_args+=("ggl-cli" "deploy")
    
    if [ "$DEPLOYMENT_MODE" = "traditional" ]; then
        deploy_cmd_args+=("--recipe-dir" "${RECIPES_DIR}")
        deploy_cmd_args+=("--artifacts-dir" "${ARTIFACTS_DIR}")
    fi
    
    deploy_cmd_args+=("--add-component" "${component_name}=${component_version}")
    
    log_info "Deploying component ${component_name}=${component_version}..."
    
    local deployment_output
    if deployment_output=$("${deploy_cmd_args[@]}" 2>&1); then
        local deployment_id=$(echo "$deployment_output" | grep -o "Deployment id: [^.]*" | cut -d' ' -f3 || echo "unknown")
        log_info "✓ Component ${component_name}=${component_version} deployment queued (ID: $deployment_id)"
        return 0
    else
        log_error "✗ Failed to deploy component ${component_name}=${component_version}"
        log_error "Output: $deployment_output"
        return 1
    fi
}

# Deploy all image components using multiple individual deployments
deploy_image_components() {
    if [ "$DEPLOYMENT_MODE" = "none" ]; then
        log_info "No image-provided components found for auto-deployment"
        return 0
    fi
    
    log_info "Scanning for valid image-provided components (${DEPLOYMENT_MODE} mode)..."
    
    local valid_count=0
    local failed_count=0
    
    for recipe in "${RECIPES_DIR}"/*.yaml; do
        [ -f "$recipe" ] || continue
        
        local component_info=$(parse_component_info "$recipe")
        local component_name=$(echo "$component_info" | cut -d: -f1)
        local component_version=$(echo "$component_info" | cut -d: -f2)
        
        log_info "Checking component: ${component_name}=${component_version}"
        
        if verify_component_exists "$component_name" "$component_version" "$recipe"; then
            log_info "✓ Component ${component_name} verified successfully"
            
            if deploy_single_component "$component_name" "$component_version"; then
                valid_count=$((valid_count + 1))
            else
                failed_count=$((failed_count + 1))
            fi
        else
            log_warn "✗ Component ${component_name} verification failed, skipping"
            failed_count=$((failed_count + 1))
        fi
    done
    
    if [ $valid_count -eq 0 ]; then
        log_error "No components deployed successfully"
        return 1
    fi
    
    log_info "Deployment summary: $valid_count successful, $failed_count failed"
    return 0
}

# Main execution
main() {
    log_info "Starting Greengrass Lite image-provided component deployment (${DEPLOYMENT_MODE} mode)"
    log_info "Using multiple individual deployments for each component"
    
    if deploy_image_components; then
        log_info "Component deployment process completed successfully"
        return 0
    else
        log_error "Component deployment failed"
        return 1
    fi
}

# Run main deployment process
main
